openapi: 3.0.3
info:
  title: Advanced Payment Devnet API
  description: REST API for Canton Network Advanced Payment operations
  version: 1.0.0

servers:
  - url: http://localhost:3030
    description: Local development server

components:
  schemas:
    # ============= Response Types =============
    SubmissionResult:
      type: object
      properties:
        submission_id:
          type: string
          description: Unique submission identifier
        update_id:
          type: string
          description: Ledger update identifier
        contract_id:
          type: string
          description: Created/updated contract ID (when applicable)
        new_contract_id:
          type: string
          description: New contract ID if funds remain (for withdraw operations)
          nullable: true
        remaining_amount:
          type: string
          description: Remaining locked amount (for withdraw operations)
          nullable: true
      required:
        - submission_id
        - update_id

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
        details:
          type: string
          description: Additional error details
      required:
        - error

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        ledger_api_url:
          type: string
        scan_api_url:
          type: string
      required:
        - status
        - ledger_api_url
        - scan_api_url

    # ============= Info Types =============
    AmuletInfo:
      type: object
      properties:
        contract_id:
          type: string
        amount:
          type: string
        is_locked:
          type: boolean
        lock_holders:
          type: array
          items:
            type: string
        lock_expires_at:
          type: string
          nullable: true
      required:
        - contract_id
        - amount
        - is_locked
        - lock_holders

    AdvancedPaymentInfo:
      type: object
      properties:
        contract_id:
          type: string
        locked_amount:
          type: string
        minimum_amount:
          type: string
        buyer:
          type: string
        seller:
          type: string
        provider:
          type: string
        expires_at:
          type: string
        description:
          type: string
          nullable: true
        reference:
          type: string
          nullable: true
      required:
        - contract_id
        - locked_amount
        - minimum_amount
        - buyer
        - seller
        - provider
        - expires_at

    AdvancedPaymentRequestInfo:
      type: object
      properties:
        contract_id:
          type: string
        locked_amount:
          type: string
        minimum_amount:
          type: string
        buyer:
          type: string
        seller:
          type: string
        provider:
          type: string
        expires_at:
          type: string
        description:
          type: string
          nullable: true
        reference:
          type: string
          nullable: true
      required:
        - contract_id
        - locked_amount
        - minimum_amount
        - buyer
        - seller
        - provider
        - expires_at

    AppServiceInfo:
      type: object
      properties:
        contract_id:
          type: string
        seller:
          type: string
        provider:
          type: string
        service_description:
          type: string
          nullable: true
      required:
        - contract_id
        - seller
        - provider

    AppServiceRequestInfo:
      type: object
      properties:
        contract_id:
          type: string
        seller:
          type: string
        provider:
          type: string
        service_description:
          type: string
          nullable: true
      required:
        - contract_id
        - seller
        - provider

    # ============= Base Credential Types =============
    SellerCredentials:
      type: object
      properties:
        jwt:
          type: string
          description: JWT for Ledger API authentication
        seller_party_id:
          type: string
          description: Seller party ID (e.g., "ext-user-phantom-1::1220...")
        seller_private_key:
          type: string
          description: Base58-encoded Ed25519 private key
      description: All fields optional - falls back to .env if not provided

    BuyerCredentials:
      type: object
      properties:
        jwt:
          type: string
          description: JWT for Ledger API authentication
        buyer_party_id:
          type: string
          description: Buyer party ID
        buyer_private_key:
          type: string
          description: Base58-encoded Ed25519 private key
      required:
        - buyer_party_id
        - buyer_private_key
      description: buyer_party_id and buyer_private_key required; jwt falls back to .env

    # ============= Service Request Types =============
    ServiceRequestCreateRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/SellerCredentials'
        - type: object
          properties:
            service_description:
              type: string
              description: Description of service relationship

    ServiceRequestAcceptRequest:
      type: object
      properties:
        jwt:
          type: string
          description: JWT (optional, falls back to .env)
        request_cid:
          type: string
          description: Contract ID of AppServiceRequest
      required:
        - request_cid

    ServiceRequestRejectRequest:
      type: object
      properties:
        jwt:
          type: string
        request_cid:
          type: string
        reason:
          type: string
          nullable: true
      required:
        - request_cid

    ServiceRequestCancelRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/SellerCredentials'
        - type: object
          properties:
            request_cid:
              type: string
          required:
            - request_cid

    ServiceTerminateRequest:
      type: object
      properties:
        jwt:
          type: string
        service_cid:
          type: string
      required:
        - service_cid

    ServiceListRequest:
      type: object
      properties:
        jwt:
          type: string
        seller_party_id:
          type: string

    # ============= Payment Request Types =============
    PaymentRequestCreateRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/SellerCredentials'
        - type: object
          properties:
            service_cid:
              type: string
              description: Contract ID of AppService
            buyer_party_id:
              type: string
              description: Party ID of buyer who will fund payment
            amount:
              type: string
              description: Amount to lock (in CC)
            minimum:
              type: string
              description: Minimum amount to keep locked
            expires:
              type: string
              description: ISO 8601 expiry time (default 1 day from now)
            description:
              type: string
              nullable: true
            reference:
              type: string
              nullable: true
          required:
            - service_cid
            - buyer_party_id
            - amount
            - minimum

    PaymentRequestAcceptRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/BuyerCredentials'
        - type: object
          properties:
            request_cid:
              type: string
              description: Contract ID of AdvancedPaymentRequest
            amulet_cids:
              type: array
              items:
                type: string
              description: Amulet contract IDs to use as funds
          required:
            - request_cid
            - amulet_cids

    PaymentRequestRejectRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/BuyerCredentials'
        - type: object
          properties:
            request_cid:
              type: string
            reason:
              type: string
              nullable: true
          required:
            - request_cid

    PaymentRequestCancelRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/SellerCredentials'
        - type: object
          properties:
            request_cid:
              type: string
          required:
            - request_cid

    # ============= Payment Operation Types =============
    PaymentWithdrawRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/SellerCredentials'
        - type: object
          properties:
            payment_cid:
              type: string
              description: Contract ID of AdvancedPayment
            amount:
              type: string
              description: Amount to withdraw (in CC)
            reason:
              type: string
              description: Withdrawal reason
              nullable: true
          required:
            - payment_cid
            - amount

    PaymentUnlockRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/BuyerCredentials'
        - type: object
          properties:
            payment_cid:
              type: string
            amount:
              type: string
          required:
            - payment_cid
            - amount

    PaymentCancelRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/SellerCredentials'
        - type: object
          properties:
            payment_cid:
              type: string
          required:
            - payment_cid

    PaymentExpireRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/BuyerCredentials'
        - type: object
          properties:
            payment_cid:
              type: string
          required:
            - payment_cid

    PaymentTopupRequest:
      type: object
      allOf:
        - $ref: '#/components/schemas/BuyerCredentials'
        - type: object
          properties:
            payment_cid:
              type: string
            amount:
              type: string
              description: Amount to add
            new_expires:
              type: string
              description: New expiry time (ISO 8601)
            amulet_cids:
              type: array
              items:
                type: string
          required:
            - payment_cid
            - amount
            - amulet_cids

    # ============= List Request Types =============
    ListAmuletsRequest:
      type: object
      properties:
        jwt:
          type: string
        party_id:
          type: string
          description: Party to list amulets for
      required:
        - party_id

    ListPaymentsRequest:
      type: object
      properties:
        jwt:
          type: string
        party_id:
          type: string
      required:
        - party_id

    ListRequestsRequest:
      type: object
      properties:
        jwt:
          type: string
        party_id:
          type: string
      required:
        - party_id

    # ============= Preapproval Request Types =============
    PreapprovalRequestRequest:
      type: object
      properties:
        jwt:
          type: string
          description: JWT for Ledger API authentication (optional, falls back to JWT_PROVIDER)
        party_id:
          type: string
          description: External party ID (receiver of the preapproval)
        private_key:
          type: string
          description: Base58-encoded Ed25519 private key for the external party
      required:
        - party_id
        - private_key

    PreapprovalAcceptRequest:
      type: object
      properties:
        jwt:
          type: string
          description: JWT for Ledger API authentication (optional, falls back to JWT_PROVIDER)

    PreapprovalCancelRequest:
      type: object
      properties:
        jwt:
          type: string
          description: JWT for Ledger API authentication
        party_id:
          type: string
          description: Party ID (defaults to PARTY_PROVIDER if not specified)

    PreapprovalTransferRequest:
      type: object
      properties:
        jwt:
          type: string
          description: JWT for Ledger API authentication (optional, falls back to JWT_PROVIDER)
        sender_party_id:
          type: string
          description: Party ID of the sender (external party)
        sender_private_key:
          type: string
          description: Base58-encoded Ed25519 private key of the sender
        receiver_party_id:
          type: string
          description: Party ID of the receiver
        amount:
          type: string
          description: Amount to transfer (in CC)
        description:
          type: string
          description: Transfer description/reason
          nullable: true
      required:
        - sender_party_id
        - sender_private_key
        - receiver_party_id
        - amount

paths:
  /api/service/request/create:
    post:
      summary: Create AppServiceRequest (seller action)
      description: Seller requests service relationship with provider
      tags: [Service]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceRequestCreateRequest'
      responses:
        '200':
          description: AppServiceRequest created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/service/request/accept:
    post:
      summary: Accept AppServiceRequest (provider action)
      description: Provider accepts service request, creating AppService
      tags: [Service]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceRequestAcceptRequest'
      responses:
        '200':
          description: AppService created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/service/request/reject:
    post:
      summary: Reject AppServiceRequest (provider action)
      description: Provider rejects service request
      tags: [Service]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceRequestRejectRequest'
      responses:
        '200':
          description: AppServiceRequest rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/service/request/cancel:
    post:
      summary: Cancel AppServiceRequest (seller action)
      description: Seller cancels their pending service request
      tags: [Service]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceRequestCancelRequest'
      responses:
        '200':
          description: AppServiceRequest canceled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/service/terminate:
    post:
      summary: Terminate AppService (provider action)
      description: Provider terminates active service relationship
      tags: [Service]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceTerminateRequest'
      responses:
        '200':
          description: AppService terminated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/service/list:
    post:
      summary: List active AppService contracts
      tags: [Service]
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceListRequest'
      responses:
        '200':
          description: List of AppService contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AppServiceInfo'

  /api/service/requests:
    post:
      summary: List pending AppServiceRequest contracts
      tags: [Service]
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceListRequest'
      responses:
        '200':
          description: List of pending AppServiceRequest contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AppServiceRequestInfo'

  /api/request/create:
    post:
      summary: Create AdvancedPaymentRequest (seller action)
      description: Seller creates payment request via AppService
      tags: [PaymentRequest]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequestCreateRequest'
      responses:
        '200':
          description: AdvancedPaymentRequest created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/request/accept:
    post:
      summary: Accept AdvancedPaymentRequest (buyer action)
      description: Buyer accepts request and locks funds
      tags: [PaymentRequest]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequestAcceptRequest'
      responses:
        '200':
          description: AdvancedPayment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/request/reject:
    post:
      summary: Reject AdvancedPaymentRequest (buyer action)
      description: Buyer rejects payment request
      tags: [PaymentRequest]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequestRejectRequest'
      responses:
        '200':
          description: AdvancedPaymentRequest rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/request/cancel:
    post:
      summary: Cancel AdvancedPaymentRequest (seller action)
      description: Seller cancels pending payment request
      tags: [PaymentRequest]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRequestCancelRequest'
      responses:
        '200':
          description: AdvancedPaymentRequest canceled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/payment/withdraw:
    post:
      summary: Withdraw from AdvancedPayment (seller action)
      description: Seller withdraws amount from locked payment
      tags: [Payment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentWithdrawRequest'
      responses:
        '200':
          description: Withdrawal successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/payment/unlock:
    post:
      summary: Unlock partial amount (buyer action)
      description: Buyer unlocks part of locked funds
      tags: [Payment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentUnlockRequest'
      responses:
        '200':
          description: Unlock successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/payment/cancel:
    post:
      summary: Cancel AdvancedPayment (seller action)
      description: Seller cancels payment, returning all funds to buyer
      tags: [Payment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCancelRequest'
      responses:
        '200':
          description: Payment canceled, funds returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/payment/expire:
    post:
      summary: Expire AdvancedPayment (buyer action)
      description: Buyer expires payment after lock expiry
      tags: [Payment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentExpireRequest'
      responses:
        '200':
          description: Payment expired, funds returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/payment/topup:
    post:
      summary: Top up AdvancedPayment (buyer action)
      description: Buyer adds funds and extends expiry
      tags: [Payment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentTopupRequest'
      responses:
        '200':
          description: TopUp successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'

  /api/list/amulets:
    post:
      summary: List amulets for a party
      tags: [List]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListAmuletsRequest'
      responses:
        '200':
          description: List of amulets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AmuletInfo'

  /api/list/payments:
    post:
      summary: List AdvancedPayment contracts for a party
      tags: [List]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListPaymentsRequest'
      responses:
        '200':
          description: List of AdvancedPayment contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdvancedPaymentInfo'

  /api/list/requests:
    post:
      summary: List AdvancedPaymentRequest contracts for a party
      tags: [List]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListRequestsRequest'
      responses:
        '200':
          description: List of AdvancedPaymentRequest contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdvancedPaymentRequestInfo'

  /api/preapproval/request:
    post:
      summary: Request TransferPreapproval for external party
      description: Creates TransferPreapprovalProposal using interactive submission (Ed25519 signing)
      tags: [Preapproval]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreapprovalRequestRequest'
      responses:
        '200':
          description: TransferPreapprovalProposal created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'
        '500':
          description: Submission failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/preapproval/accept:
    post:
      summary: Accept pending TransferPreapprovalProposals
      description: Provider accepts all pending proposals where provider=PARTY_PROVIDER
      tags: [Preapproval]
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreapprovalAcceptRequest'
      responses:
        '200':
          description: List of update IDs for accepted proposals
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
        '500':
          description: Operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/preapproval/cancel:
    post:
      summary: Cancel TransferPreapproval contracts
      description: Cancels all TransferPreapproval contracts for a party
      tags: [Preapproval]
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreapprovalCancelRequest'
      responses:
        '200':
          description: List of update IDs for cancelled preapprovals
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
        '500':
          description: Operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/preapproval/transfer:
    post:
      summary: Transfer Canton Coin via TransferPreapproval
      description: Transfer using TransferFactory_Transfer with interactive submission (Ed25519 signing)
      tags: [Preapproval]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreapprovalTransferRequest'
      responses:
        '200':
          description: Transfer successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmissionResult'
        '500':
          description: Transfer failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/health:
    get:
      summary: Health check
      tags: [System]
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
