# Add SP1 Contract - Sui Implementation

This directory contains the Sui Move implementation of the Add SP1 contract, equivalent to the Ethereum `ethereum/src/Add.sol` contract.

## Structure

```
move/
├── sp1/                    # Main Move package
│   ├── Move.toml          # Package manifest
│   ├── sources/
│   │   └── sp1.move       # Add contract implementation
│   └── tests/
│       └── sp1_tests.move # Contract tests
├── client/                # Rust client for interaction
│   ├── Cargo.toml
│   └── src/
│       └── main.rs        # Sui client implementation
├── test.sh               # Test script
└── README.md            # This file
```

## Contract Features

The Move contract `add_sp1::add_sp1` provides the same functionality as the Ethereum version:

- **State Management**: Maintains a running sum state starting at 0
- **SP1 Proof Verification**: Uses Sui's native Groth16 verification for SP1 proofs
- **State Validation**: Ensures `old_sum` in proof matches current contract state
- **Computation Verification**: Validates that `new_sum = old_sum + value`
- **Event Emission**: Emits `SumUpdated` events when state changes
- **Error Handling**: Proper error codes for invalid states and computations

### Key Functions

1. `create_contract(vkey: vector<u8>)` - Initialize a new Add contract
2. `share_contract(contract)` - Make contract globally accessible
3. `verify_add_proof(contract, public_values, proof)` - Main verification function
4. `get_current_sum(contract)` - Read current sum state
5. `get_vkey(contract)` - Read verification key

## Rust Client

The `client/` directory contains a Rust client (`AddSuiClient`) that provides:

- **Contract Creation**: Deploy new Add contracts on Sui
- **Proof Verification**: Submit proofs for verification
- **State Reading**: Query current contract state
- **Transaction Management**: Handle gas, signing, and execution

### Client Features

```rust
// Initialize client
let client = AddSuiClient::new(config).await?;

// Create new contract
let contract_id = client.create_contract(vkey).await?;

// Verify proof
let (value, old_sum, new_sum) = client.verify_add_proof(
    public_values_bytes,
    proof_bytes
).await?;

// Read state
let current_sum = client.get_current_sum().await?;
```

## Differences from Ethereum Version

### Move-Specific Adaptations

1. **Object Model**: Uses Sui's object model with shared objects for global state
2. **Native Groth16**: Leverages Sui's built-in Groth16 verification instead of external verifier
3. **Event System**: Uses Move's event emission instead of Solidity events
4. **Error Handling**: Uses Move's `assert!` with error constants instead of custom errors
5. **Type System**: Uses Move's type system with proper abilities (`key`, `store`, `copy`, `drop`)

### Public Values Parsing

The Move contract includes a custom parser for SP1 public values since Move doesn't have direct equivalent to Solidity's `abi.decode`:

```move
fun parse_public_values(bytes: vector<u8>): PublicValues {
    // Extract 3 u32 values from bytes (little endian)
    let value = extract_u32_at(&bytes, 0);
    let old_sum = extract_u32_at(&bytes, 4);
    let new_sum = extract_u32_at(&bytes, 8);
    // ...
}
```

## Testing

### Build and Test Move Contract

```bash
cd sp1
sui move build
sui move test
```

### Test with Script

```bash
./test.sh
```

### Manual Testing Steps

1. **Deploy Contract**: Use Sui CLI or client to deploy the Move package
2. **Create Contract**: Call `create_contract` with verification key
3. **Generate Proof**: Use the existing SP1 proving system to generate proofs
4. **Verify Proof**: Submit proof to `verify_add_proof` function
5. **Check State**: Verify state updates correctly

## Integration with Existing SP1 System

The Sui contract integrates with the existing Add SP1 system:

1. **Same Verification Key**: Uses the same `addProgramVKey` from Ethereum contract
2. **Compatible Proofs**: Accepts the same SP1 proofs generated by the program
3. **Identical Logic**: Implements the same addition verification and state management
4. **Similar API**: Provides equivalent functions to Ethereum contract

## Configuration

### Move.toml Dependencies

```toml
[dependencies]
Sui = { git = "https://github.com/MystenLabs/sui.git", subdir = "crates/sui-framework/packages/sui-framework", rev = "framework/testnet" }
```

### Client Dependencies

```toml
[dependencies]
anyhow = "1.0"
tokio = { version = "1.0", features = ["full"] }
sui-sdk = "1.0"
sui-keys = "1.0"
bcs = "0.1"
hex = "0.4"
serde = { version = "1.0", features = ["derive"] }
```

## Deployment Instructions

1. **Build Package**: `sui move build`
2. **Publish Package**: `sui client publish --gas-budget 10000000`
3. **Note Package ID**: Save the published package ID for client configuration
4. **Create Contract**: Call `create_contract` with your verification key
5. **Note Contract ID**: Save the shared object ID for future interactions

## Usage Example

```rust
// Configure client
let config = AddContractConfig {
    package_id: ObjectID::from_str("0x...")?,
    contract_object_id: ObjectID::from_str("0x...")?,
    private_key: "your_private_key".to_string(),
};

// Initialize
let client = AddSuiClient::new(config).await?;

// Use with existing SP1 proofs
let public_values = /* from SP1 */;
let proof = /* from SP1 */;
let result = client.verify_add_proof(public_values, proof).await?;
```

This implementation provides full compatibility with the existing SP1 Add system while leveraging Sui's unique features and performance advantages.
